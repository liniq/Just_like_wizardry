<html>
<head>
<title>Just like wizardry</title>
<link rel="stylesheet" type="text/css" href="css/Styles.css">
<script src="js/excanvas.js" type="text/javascript"></script>
<script src="./level.js"></script>
<script src="./objectTypes.js"></script>
<script src="./gameEngine.js"></script>
<script src="js/objectTextures.js" type="text/javascript"></script>
<script src="js/renderer.js" type="text/javascript"></script>
<script src="/socket.io/socket.io.js" type="text/javascript"></script>
</head>
<body>

<div id="screen">
	<div id="floor"></div>
	<div id="ceiling"></div>
	
	<div id="minimapcontainer">
		<canvas id="minimap"></canvas>
		<canvas id="minimapobjects"></canvas>
	</div>
    <span id="chat"></span>
	<div id="party">
	    <div class="one left">
			<span id="playername2" class="name">Laur</span> <span id="playerhp2">hp: 4</span><br>
			<img id="playerportret2" class="portret" src="img/templar_assassin_hphover.png" alt="" /><br>
			<span class="yel">Action:</span> <span id="playeraction2">Defend yourself</span>
		</div>
		
		 <div class="one left">
			<span id="playername3" class="name">Markus</span> <span id="playerhp3">hp: 6</span><br>
			<img id="playerportret3" class="portret" src="img/keeper_of_the_light_hphover.png" alt="" /><br>
			<span id="playeraction3">NOT READY</span>
		</div>
		
		<div class="one left">
			<span id="playername4" class="name">Liniq</span> <span id="playerhp4">hp: 4</span><br>
			<img id="playerportret4" class="portret" src="img/life_stealer_hphover.png" alt="" /><br>
			<span class="yel">Action:</span> <span id="playeraction4">Defend yourself</span>
		</div>
	</div>
	
	<div id="ui">
	    <img class="portret" src="img/omniknight_hphover.png" alt="" />
		<div id="hero">
			<div class="name left"><span id="name">Airiz</span><br>
			<span>Skill:</span> <span id="skilldescription">heal the target 5hp</span>
			</div>
			
			
			<div class="left">
				<span>HP:</span> <span id="hitpoint">10</span><br>
				<span>Damage:</span> <span id="damage">2-4</span><br>
				<span>Defence:</span> <span id="defence">3</span><br>
			</div>
			
			<div class="but left">
				<a id="hit" href="#"><img src="img/itemcat_weapons.png" alt="" /></a>
				<a id="defend" href="#"><img src="img/itemcat_attributes.png" alt="" /></a>
				<a id="castspell" href="#"><img src="img/itemcat_support.png" alt="" /></a>
			</div>
			
			<div id="target" class="action left">
				<select id="chstarget">
					<option>Airiz</option>
					<option>Laur</option>
					<option>Markus</option>
					<option>Liniq</option>
					<option>Enemy</option>
				</select>
				<br>
				<span class="yel">Action:</span> <span id="action">Defend yourself</span>
				<input type="button" id="masterbutt"  value="request control" onclick="requestControl()" />
			</div>
			
			<div class="ready right">
				<a id="ready" class="yel" href="#">READY!</a>
				 
			</div>
		</div>
	</div>
		
</div>



<div id="debug"></div>

<script type="text/javascript">
    var game = new Game(window.gameLevel,window.gameTypes);
    var ren;// = new Renderer(game,textures,$('screen'));
function init() {

    initNetwork();

    game.on('update', render);
    //start when receive join from server
    //game.updateEvery(Game.UPDATE_INTERVAL,0);


}

function render() {
    ren.renderCycle();
}

var socket = io();
var nickname;
function initNetwork()
{
	    // Check if nickname stored in localStorage
        if('localStorage' in window && localStorage.getItem('nickname')) {
            nickname = localStorage.getItem('nickname');
        } else {
            // If not in localStorage, prompt user for nickname
            nickname = prompt('Please enter your nickname','losos'+(new Date().getSeconds()));
            if('localStorage' in window) {
                localStorage.setItem('nickname', nickname);
            }
        }
        socket.on('id', function(sockid) {
            socket.id=sockid;
            //console.log("got id "+sockid);
        });

        socket.emit('join', nickname);

        socket.on('join', function(data) {
            if (data.nick) {
                $("chat").innerHTML += "<br/>" + data.nick +" joined the game!";
                setTimeout(clearChat,5000);
            } else if (data.objects) {
                game.load(data);
                //start
                ren = new Renderer(game,textures,$('screen'));
                game.updateEvery(Game.UPDATE_INTERVAL,0);
            }
        });
        socket.on('masterChanged', function(data) {
            $("chat").innerHTML += "<br/>" + data.nick + " now controls movements!";
            console.log("my id "+ socket.id + " data id " +data.id+ " eq=" +(socket.id == data.id));
            if (socket.id == data.id)
            {
                //alert("you now control movements. Use buttons to move");
                bindKeys();
                //$('masterbutt').disabled=true;
            }
            else
            {
                document.onkeyup = null;
                document.onkeydown = null;
                //$('masterbutt').disabled=false;
            }
            setTimeout(clearChat,5000);
        });

        socket.on('leave', function(nick) {
            $("chat").innerHTML += "<br/>" + nick + " left the game!";
            setTimeout(clearChat,5000);
        });


        socket.on('move', function(data) {
            game.actionArray.push ({
              turn: data.t,
              move: data.m
            });
            var pl = game.state.objects[0];
            pl.x = data.x;
            pl.y = data.y;
            pl.angle = data.a;
        });
}

function requestControl()
{
    socket.emit('masterChanged',nickname);
}

function clearChat()
{
    $("chat").innerHTML ="";
}

var storedUserInput = {m:0, t:0};
var sentUserInput = {m:0, t:0};
var minUserInputInterval = 50;
var lastUserInputTS = 0;
function sendUserInput(){
    if (sentUserInput.m == storedUserInput.m && sentUserInput.t == storedUserInput.t) {
        return;
    }
    var delta = new Date().valueOf() - lastUserInputTS;
    if (delta < minUserInputInterval) {
        setTimeout(sendUserInput, delta);
        return;
    }
    console.log("send userinput");
    sentUserInput.m = storedUserInput.m;
    sentUserInput.t = storedUserInput.t;
    lastUserInputTS = new Date().valueOf();
    socket.emit('move',sentUserInput);

}
// bind keyboard events to game functions (movement, etc)
function bindKeys() {
	document.onkeydown = function(e) {
		e = e || window.event;
        switch (e.keyCode) { // which key was pressed?
			case 38: // up, move player forward, ie. increase speed
                storedUserInput.m=1;
				break;
            case 40: // down, move player backward, set negative speed
                storedUserInput.m=-1;
				break;
			case 37: // left, rotate player left
                storedUserInput.t=-1;
				break;
			case 39: // right, rotate player right
                storedUserInput.t=1;
				break;
		}
        sendUserInput();
	};

	document.onkeyup = function(e) {
		e = e || window.event;
        switch (e.keyCode) {
			case 38:
			case 40:
                storedUserInput.m=0;
				break;
			case 37:
			case 39:
                storedUserInput.t=0;
				break;
		}
        sendUserInput();
	};
}

setTimeout(init, 1);

</script>



</body>